<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>정류장 검색</title>
    <style>
        table {
            border-collapse: collapse;
        }

        th,
        td {
            border: 1px solid black;
            padding: 8px;
        }
    </style>

    <script>
        //---------------Page 로딩시 html Geolocation (위도 ,경도 데이터 ) 넘겨주는 Method----------
        function geolocationData() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(requestData);
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        //500m 내에 근접 정류소 리스트 가까운 거리순으로 정렬 table
        //500m 내에 근접 정류소 리스트 가까운 거리순으로 정렬 table
        //--------------------------주변 정류장 목록 조회 (500M) Start-------------------------
        function requestData(position) {
            var latitude = position.coords.latitude;
            var longitude = position.coords.longitude;

            var xhr1 = new XMLHttpRequest();
            var url = 'https://apis.data.go.kr/1613000/BusSttnInfoInqireService/getCrdntPrxmtSttnList'; /*URL*/


            var queryParams = '?' + encodeURIComponent('serviceKey') + '=' + '4BqitnePMI85LNaRrU9Cb1BjPByUQT5ahPiycrGnHMX7tvlyV8VN6ESZmUiA9Urhv2m%2BCzm37j63rQHw%2FP1Wpg%3D%3D'; /*Service Key*/
            queryParams += '&' + encodeURIComponent('pageNo') + '=' + encodeURIComponent('1'); /**/
            queryParams += '&' + encodeURIComponent('numOfRows') + '=' + encodeURIComponent('10'); /**/
            queryParams += '&' + encodeURIComponent('_type') + '=' + encodeURIComponent('json'); /**/
            queryParams += '&' + encodeURIComponent('gpsLati') + '=' + encodeURIComponent(latitude); /**/
            queryParams += '&' + encodeURIComponent('gpsLong') + '=' + encodeURIComponent(longitude); /**/

            xhr1.onreadystatechange = function () {
                if (this.readyState === 4 && this.status === 200) {
                    var responseData = this.responseText;
                    responseData = responseData.replace(/(<([^>]+)>)/ig, ""); // 응답 데이터에서 HTML 태그 제거
                    var parseData = JSON.parse(responseData);
                    handleData(parseData, latitude, longitude);
                }
            };

            xhr1.open('GET', url + queryParams, true);
            xhr1.send();
        }

        function handleData(parseData, latitude, longitude) {
            var tbody = document.getElementById('busStationBody');

            if (Array.isArray(parseData.response.body.items.item)) {
                var items = parseData.response.body.items.item;

                // 정류소까지의 거리 계산
                items.forEach(function (item) {
                    var itemLatitude = parseFloat(item.gpslati);
                    var itemLongitude = parseFloat(item.gpslong);
                    var distance = calculateDistance(latitude, longitude, itemLatitude, itemLongitude);

                    item.distance = distance; // 거리 정보 추가
                });

                // 거리를 오름차순으로 정렬
                items.sort(function (a, b) {
                    return a.distance - b.distance;
                });

                // 테이블에 정류소 정보 표시
                items.forEach(function (item) {
                    if (item.nodeid.startsWith("DGB")) { // DGB로 시작하는 데이터만 선택
                        var Item1 = item;
                        var nodenm1 = item.nodenm;
                        var distance = item.distance.toFixed(2) + 'm';
                        var nodeid1 = item.nodeid;
                        const stationNameLink = document.createElement('button');

                        var row = document.createElement('tr');
                        var cell1 = document.createElement('td');
                        var cell2 = document.createElement('td');
                        var cell3 = document.createElement('td');
                        var cell4 = document.createElement('td');

                        stationNameLink.textContent = "선택";
                        stationNameLink.href = "#1";
                        stationNameLink.addEventListener('click', function () {
                            // document.getElementById('test').innerText = Item.nodeid;
                            var NodeId = Item1.nodeid;
                            lowbusStation(NodeId);
                        });


                        cell1.textContent = nodenm1;
                        cell2.textContent = distance;
                        cell3.textContent = nodeid1;
                        cell4.appendChild(stationNameLink);

                        row.appendChild(cell1);
                        row.appendChild(cell2);
                        row.appendChild(cell3);
                        row.appendChild(cell4);
                        tbody.appendChild(row);
                    }
                });
            }
        }


        //현재 위치로 부터 정류장 거리 구하는 Method
        function calculateDistance(lat1, lon1, lat2, lon2) {
            var R = 6371; // 지구의 반경 (km)
            var dLat = deg2rad(lat2 - lat1);
            var dLon = deg2rad(lon2 - lon1);
            var a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            var distance = R * c * 1000; // 미터로 변환
            return distance;
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }

        //--------------------------주변 정류장 목록 조회 (500M) End-------------------------


        //--------------------------정류장 선택시 버스 도착 정보 조회 Start-------------------------

        function lowbusStation(NodeId) {
            document.getElementById('busStationBody').innerHTML = '';
            document.getElementById('meter').textContent = '버스 유형';
            document.getElementById('nodeId').textContent = '남은 정류장수';
            var thead = document.getElementById('tableHead');

            var th = document.getElementById('selectNm');
            th.textContent = "노선번호";
            thead.appendChild(th);

            var th2 = document.createElement('th');
            th2.textContent = "도착 예정 시간";
            thead.appendChild(th2);

            var th3 = document.createElement('th');
            th3.textContent = "선택하기";
            thead.appendChild(th3);


            var nodeId = NodeId;
            var xhr2 = new XMLHttpRequest();
            var url2 = 'https://apis.data.go.kr/1613000/ArvlInfoInqireService/getSttnAcctoArvlPrearngeInfoList'; /*URL*/


            var queryParams = '?' + encodeURIComponent('serviceKey') + '=' + '4BqitnePMI85LNaRrU9Cb1BjPByUQT5ahPiycrGnHMX7tvlyV8VN6ESZmUiA9Urhv2m%2BCzm37j63rQHw%2FP1Wpg%3D%3D'; /*Service Key*/
            queryParams += '&' + encodeURIComponent('pageNo') + '=' + encodeURIComponent('1'); /**/
            queryParams += '&' + encodeURIComponent('numOfRows') + '=' + encodeURIComponent('10'); /**/
            queryParams += '&' + encodeURIComponent('_type') + '=' + encodeURIComponent('json'); /**/
            queryParams += '&' + encodeURIComponent('cityCode') + '=' + encodeURIComponent('22'); /**/
            queryParams += '&' + encodeURIComponent('nodeId') + '=' + encodeURIComponent(nodeId); /**/

            xhr2.onreadystatechange = function () {
                if (this.readyState === 4 && this.status === 200) {
                    var responseData = this.responseText;

                    responseData = responseData.replace(/(<([^>]+)>)/ig, ""); // 응답 데이터에서 HTML 태그 제거
                    var parseData = JSON.parse(responseData);

                    // document.getElementById('test').textContent = parseData.response.body.items.item[0];
                    lowbusParse(parseData);


                }

            }
            xhr2.open('GET', url2 + queryParams, true);
            xhr2.send();


        }


        function lowbusParse(parseData) {
            var tbody = document.getElementById('busStationBody');
            if (Array.isArray(parseData.response.body.items.item)) {
                var items = parseData.response.body.items.item;
                items = items.filter(function (item) {
                    return item.vehicletp === '저상버스';
                });
                // Convert time from seconds to minutes
                items.forEach(function (item) {
                    item.arrtime = Math.floor(item.arrtime / 60); // Convert seconds to minutes
                });
                items.sort(function (a, b) {
                    return a.arrtime - b.arrtime; // arrtime을 기준으로 오름차순 정렬
                });
                // 테이블에 정류소 정보 표시
                items.forEach(function (item) {

                    var nodenm = item.nodenm;
                    var vehicletp = item.vehicletp;
                    var arrprevstationcnt = item.arrprevstationcnt;
                    var routeno = item.routeno;
                    var arrtime = item.arrtime;

                    var endStationLink = document.createElement('button');


                    var row = document.createElement('tr');
                    var cell1 = document.createElement('td');
                    var cell2 = document.createElement('td');
                    var cell3 = document.createElement('td');
                    var cell4 = document.createElement('td');
                    var cell5 = document.createElement('td');
                    var cell6 = document.createElement('td');

                    endStationLink.textContent = "선택";
                    endStationLink.href = "#2"
                    endStationLink.addEventListener('click', function () {
                        var routeId = item.routeid;
                        var nodeNm = item.nodenm;
                        endStation(routeId,nodeNm);
                    });


                    cell1.textContent = nodenm;
                    cell2.textContent = vehicletp;
                    cell3.textContent = arrprevstationcnt;
                    cell4.textContent = routeno;
                    cell5.textContent = arrtime + "분";
                    cell6.appendChild(endStationLink);


                    row.appendChild(cell1);
                    row.appendChild(cell2);
                    row.appendChild(cell3);
                    row.appendChild(cell4);
                    row.appendChild(cell5);
                    row.appendChild(cell6);
                    tbody.appendChild(row);
                });

            }

        }

        //---------------------------------저상버스 도착 정보 조회 End---------------------------------------

        //---------------------------------노선 경로 도착지 리스트  조회 End---------------------------------------
        function endStation(routeId,nodeNm) {
            document.getElementById('busStationBody').innerHTML = '';
            document.getElementById('busStationHead').innerHTML='';


            var thead = document.getElementById('busStationHead');
            var ttr = document.createElement('tr');
            var th1 = document.createElement('th');
            var th2 = document.createElement('th');
            var th3 = document.createElement('th');
            var th4 = document.createElement('th');

            th1.textContent = '정류장 명';
            th2.textContent = '정류소 순번';
            th3.textContent = '상해행 구분';
            th4.textContent = '선택하기';


            ttr.appendChild(th1);
            ttr.appendChild(th2);
            ttr.appendChild(th3);
            ttr.appendChild(th4);



            thead.appendChild(ttr);


            var Routeid = routeId;
            var Nodenm = nodeNm;
            var xhr3 = new XMLHttpRequest();
            var url3 = 'https://apis.data.go.kr/1613000/BusRouteInfoInqireService/getRouteAcctoThrghSttnList'; /*URL*/


            var queryParams = '?' + encodeURIComponent('serviceKey') + '=' + '4BqitnePMI85LNaRrU9Cb1BjPByUQT5ahPiycrGnHMX7tvlyV8VN6ESZmUiA9Urhv2m%2BCzm37j63rQHw%2FP1Wpg%3D%3D'; /*Service Key*/
            queryParams += '&' + encodeURIComponent('numOfRows') + '=' + encodeURIComponent('100'); /**/
            queryParams += '&' + encodeURIComponent('pageNo') + '=' + encodeURIComponent('1'); /**/
            queryParams += '&' + encodeURIComponent('_type') + '=' + encodeURIComponent('json'); /**/
            queryParams += '&' + encodeURIComponent('cityCode') + '=' + encodeURIComponent('22'); /**/
            queryParams += '&' + encodeURIComponent('routeId') + '=' + encodeURIComponent(Routeid); /**/

            xhr3.onreadystatechange = function () {
                if (this.readyState === 4 && this.status === 200) {
                    var responseData = this.responseText;

                    responseData = responseData.replace(/(<([^>]+)>)/ig, ""); // 응답 데이터에서 HTML 태그 제거
                    var parseData = JSON.parse(responseData);



                    endStationParse(parseData,Nodenm);


                }

            }
            xhr3.open('GET', url3 + queryParams, true);
            xhr3.send();
        }

        function endStationParse(parseData,Nodenm) {
            var tbody = document.getElementById('busStationBody');


            var numCnt = 0;
            if (Array.isArray(parseData.response.body.items.item)) {
                numCnt++;

                var items = parseData.response.body.items.item;
                var startIndex = items.findIndex(function (item) {
                    return item.nodenm === Nodenm;
                });



                var filteredItems = [];
                items.forEach(function(item) {
                    if (item.updowncd === 1) {
                        item.updowncd = '↑'; // 화살표 위표시로 변경
                        if (startIndex !== -1) {
                            filteredItems = items.slice(0, startIndex + 1);
                        }
                    } else if (item.updowncd === 0) {
                        item.updowncd = '↓'; // 화살표 아래표시로 변경
                        if (startIndex !== -1) {
                            filteredItems = items.slice(startIndex);
                        }
                    }
                });

                // 테이블에 정류소 정보 표시
                filteredItems.forEach(function (item) {
                    // var Item = itme;
                    var nodenm3 = item.nodenm;
                    var nodeord = item.nodeord;
                    var updowncd = item.updowncd;


                    var endStationLink = document.createElement('Button');


                    var row = document.createElement('tr');
                    var cell1 = document.createElement('td');
                    var cell2 = document.createElement('td');
                    var cell3 = document.createElement('td');
                    var cell4 = document.createElement('td');


                    endStationLink.textContent = "선택";
                    endStationLink.href = "#3"
                    endStationLink.addEventListener('click', function () {

                    });


                    cell1.textContent = nodenm3;
                    cell2.textContent = nodeord;
                    cell3.textContent = updowncd;
                    cell4.appendChild(endStationLink);


                    row.appendChild(cell1);
                    row.appendChild(cell2);
                    row.appendChild(cell3);
                    row.appendChild(cell4);



                    tbody.appendChild(row);
                });


            }
        }


        window.onload = geolocationData;
    </script>
</head>

<body>
<table id="busStationTable">
    <thead  id="busStationHead">
    <tr id="tableHead">
        <th id='nodenm'>정류소 명</th>
        <th id='meter'>거리</th>
        <th id='nodeId'>nodeid</th>
        <th id="selectNm">정류소 선택</th>
    </tr>
    </thead>
    <tbody id="busStationBody"></tbody>

</table>

<div id="test"></div>


</body>

</html>

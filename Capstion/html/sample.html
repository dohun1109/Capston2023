<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        table {
            border-collapse: collapse;
        }

        th,
        td {
            border: 1px solid black;
            padding: 8px;
        }
    </style>
</head>

<body>
<table id="busStationTable">
    <thead>
    <tr id="tableHead">
        <th id='nodenm'>정류소 명</th>
        <th id='meter'>거리</th>
        <th id='nodeId'>nodeid</th>
    </tr>
    </thead>
    <tbody id="busStationBody"></tbody>
</table>

<div id="test"></div>


<script>
    //500m 내에 근접 정류소 리스트 가까운 거리순으로 정렬 table
    //500m 내에 근접 정류소 리스트 가까운 거리순으로 정렬 table
    function handleData(parseData, latitude, longitude) {
        var tbody = document.getElementById('busStationBody');

        if (Array.isArray(parseData.response.body.items.item)) {
            var items = parseData.response.body.items.item;

            // 정류소까지의 거리 계산
            items.forEach(function (item) {
                var itemLatitude = parseFloat(item.gpslati);
                var itemLongitude = parseFloat(item.gpslong);
                var distance = calculateDistance(latitude, longitude, itemLatitude, itemLongitude);

                item.distance = distance; // 거리 정보 추가
            });

            // 거리를 오름차순으로 정렬
            items.sort(function (a, b) {
                return a.distance - b.distance;
            });

            // 테이블에 정류소 정보 표시
            items.forEach(function (item) {
                var Item = item;
                var nodenm = item.nodenm;
                var distance = item.distance.toFixed(2) + 'm';
                var nodeid = item.nodeid;
                const stationNameLink = document.createElement('a');

                var row = document.createElement('tr');
                var cell1 = document.createElement('td');
                var cell2 = document.createElement('td');
                var cell3 = document.createElement('td');

                stationNameLink.textContent = nodenm;
                stationNameLink.href = "#1"
                stationNameLink.addEventListener('click', function () {
                    // document.getElementById('test').innerText = Item.nodeid;
                    var NodeId = Item.nodeid;
                    lowbusStation(NodeId);
                });


                cell1.appendChild(stationNameLink);
                cell2.textContent = distance;
                cell3.textContent = nodeid;

                row.appendChild(cell1);
                row.appendChild(cell2);
                row.appendChild(cell3);
                tbody.appendChild(row);
            });
        }
    }

    function lowbusStation(NodeId) {
        document.getElementById('busStationBody').innerHTML = '';
        document.getElementById('meter').textContent = '버스 유형';
        document.getElementById('nodeId').textContent = '남은 정류장수';
        var thead = document.getElementById('tableHead');

        var th = document.createElement('th');
        th.textContent = "도착 예정 시간";
        thead.appendChild(th);

        var nodeId = NodeId;
        var xhr2 = new XMLHttpRequest();
        var url2 = 'http://apis.data.go.kr/1613000/ArvlInfoInqireService/getSttnAcctoArvlPrearngeInfoList'; /*URL*/


        var queryParams = '?' + encodeURIComponent('serviceKey') + '=' + '4BqitnePMI85LNaRrU9Cb1BjPByUQT5ahPiycrGnHMX7tvlyV8VN6ESZmUiA9Urhv2m%2BCzm37j63rQHw%2FP1Wpg%3D%3D'; /*Service Key*/
        queryParams += '&' + encodeURIComponent('pageNo') + '=' + encodeURIComponent('1'); /**/
        queryParams += '&' + encodeURIComponent('numOfRows') + '=' + encodeURIComponent('10'); /**/
        queryParams += '&' + encodeURIComponent('_type') + '=' + encodeURIComponent('json'); /**/
        queryParams += '&' + encodeURIComponent('cityCode') + '=' + encodeURIComponent('22'); /**/
        queryParams += '&' + encodeURIComponent('nodeId') + '=' + encodeURIComponent(nodeId); /**/

        xhr2.onreadystatechange = function () {
            if (this.readyState === 4 && this.status === 200) {
                var responseData = this.responseText;

                responseData = responseData.replace(/(<([^>]+)>)/ig, ""); // 응답 데이터에서 HTML 태그 제거
                var parseData = JSON.parse(responseData);

                // document.getElementById('test').textContent = parseData.response.body.items.item[0];
                lowbusParse(parseData);


            }

        }
        xhr2.open('GET', url2 + queryParams, true);
        xhr2.send();


    }

    function lowbusParse(parseData) {
        var tbody = document.getElementById('busStationBody');
        if (Array.isArray(parseData.response.body.items.item)) {
            var items = parseData.response.body.items.item;
            items = items.filter(function(item) {
                return item.vehicletp === '저상버스';
            });
            // Convert time from seconds to minutes
            items.forEach(function(item) {
                item.arrtime = Math.floor(item.arrtime / 60); // Convert seconds to minutes
            });
            // 테이블에 정류소 정보 표시
            items.forEach(function (item) {

                var nodenm = item.nodenm;
                var vehicletp = item.vehicletp;
                var arrprevstationcnt = item.arrprevstationcnt;
                var arrtime = item.arrtime;


                var row = document.createElement('tr');
                var cell1 = document.createElement('td');
                var cell2 = document.createElement('td');
                var cell3 = document.createElement('td');
                var cell4 = document.createElement('td');


                cell1.textContent = nodenm;
                cell2.textContent = vehicletp;
                cell3.textContent = arrprevstationcnt;
                cell4.textContent = arrtime + "분";

                row.appendChild(cell1);
                row.appendChild(cell2);
                row.appendChild(cell3);
                row.appendChild(cell4);
                tbody.appendChild(row);
            });

        }

    }


    function calculateDistance(lat1, lon1, lat2, lon2) {
        var R = 6371; // 지구의 반경 (km)
        var dLat = deg2rad(lat2 - lat1);
        var dLon = deg2rad(lon2 - lon1);
        var a =
            Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
            Math.sin(dLon / 2) * Math.sin(dLon / 2);
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        var distance = R * c * 1000; // 미터로 변환
        return distance;
    }

    function deg2rad(deg) {
        return deg * (Math.PI / 180);
    }

    function geolocationData() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(requestData);
        } else {
            alert("Geolocation is not supported by this browser.");
        }
    }

    function requestData(position) {
        var latitude = position.coords.latitude;
        var longitude = position.coords.longitude;

        var xhr1 = new XMLHttpRequest();
        var url = 'http://apis.data.go.kr/1613000/BusSttnInfoInqireService/getCrdntPrxmtSttnList'; /*URL*/


        var queryParams = '?' + encodeURIComponent('serviceKey') + '=' + '4BqitnePMI85LNaRrU9Cb1BjPByUQT5ahPiycrGnHMX7tvlyV8VN6ESZmUiA9Urhv2m%2BCzm37j63rQHw%2FP1Wpg%3D%3D'; /*Service Key*/
        queryParams += '&' + encodeURIComponent('pageNo') + '=' + encodeURIComponent('1'); /**/
        queryParams += '&' + encodeURIComponent('numOfRows') + '=' + encodeURIComponent('10'); /**/
        queryParams += '&' + encodeURIComponent('_type') + '=' + encodeURIComponent('json'); /**/
        queryParams += '&' + encodeURIComponent('gpsLati') + '=' + encodeURIComponent(latitude); /**/
        queryParams += '&' + encodeURIComponent('gpsLong') + '=' + encodeURIComponent(longitude); /**/

        xhr1.onreadystatechange = function () {
            if (this.readyState === 4 && this.status === 200) {
                var responseData = this.responseText;
                responseData = responseData.replace(/(<([^>]+)>)/ig, ""); // 응답 데이터에서 HTML 태그 제거
                var parseData = JSON.parse(responseData);
                handleData(parseData, latitude, longitude);
            }
        };

        xhr1.open('GET', url + queryParams, true);
        xhr1.send();
    }


    window.onload = geolocationData;
</script>
</body>

</html>
